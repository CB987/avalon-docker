version: '3.2'

volumes:
  streaming:
  fedora:
  work:
  solr:

services:
  fedora:
    image: nulib/fcrepo4:s3fix 
    logging:
      driver: "awslogs"
      options:
        awslogs-group: "${FEDORA_LOGGROUP}"
        awslogs-create-group: "true"
    environment:
      - MODESHAPE_CONFIG=classpath:/config/jdbc-postgresql-s3/repository.json
      - JAVA_OPTIONS=${FEDORA_OPTIONS}
    volumes:
      - fedora:/data
  solr:
    image: avalonmediasystem/solr:latest
    build:
      context: ./solr
      args:
        - AVALON_BRANCH=develop
    volumes:
      - solr:/opt/solr/server/solr/mycores
    entrypoint:
      - docker-entrypoint.sh
      - solr-precreate
      - avalon
      - /opt/solr/avalon_conf
    ports:
      - 8983:8983
  hls:
    image: avalonmediasystem/nginx
    build:
      context: ./nginx
    environment:
      - AVALON_STREAMING_BUCKET=${AVALON_STREAMING_BUCKET}
    volumes:
      - streaming:/data
    ports:
       - "8880:80"
  redis:
    image: redis:alpine
  avalon:
    image: avalonmediasystem/avalon:6.5
    env_file:
      - .env_avalon
    logging:
      driver: "awslogs"
      options:
        awslogs-group: "${AVALON_LOGGROUP}"
        awslogs-create-group: "true"
    build:
      context: ./avalon
      args:
        - AVALON_BRANCH=develop
        - SECRET_KEY_BASE=8816bf03a9da7e8b2e42095c876446b0b790296247e410181618b429a759fbeae1e16f2264195fc1765211e2d56a08ee29c02d1a135b45d45f5da7a7e0516d49
        - BASE_URL
    depends_on:
      - fedora
      - solr
      - redis
    environment:
      - APP_NAME
      - SECRET_KEY_BASE
      - ASSET_HOST
      - DATABASE_URL=${DATABASE_URL}
      - EMAIL_COMMENTS
      - EMAIL_NOTIFICATION
      - EMAIL_SUPPORT
      - FEDORA_BASE_PATH
      - FEDORA_NAMESPACE=avalon
      - FEDORA_URL=http://fedoraAdmin:fedoraAdmin@fedora:8080/rest
      - SETTINGS__FFMPEG_PATH=/usr/bin/ffmpeg
      - MASTER_FILE_PATH
      - MASTER_FILE_STRATEGY=delete
      - SETTINGS__MATTERHORN__MEDIA_PATH=/masterfiles
      - MEDIAINFO_PATH=/usr/bin/mediainfo
      - RAILS_ENV=production
      - SETTINGS__REDIS__HOST=${ELASTICACHE_HOST}
      - SETTINGS__REDIS__PORT=6379
      - SMTP_ADDRESS
      - SMTP_AUTHENTICATION
      - SMTP_DOMAIN
      - SMTP_ENABLE_STARTTLS_AUTO
      - SMTP_OPENSSL_VERIFY_MODE
      - SMTP_PASSWORD
      - SMTP_PORT
      - SMTP_USER_NAME
      - SOLR_URL=http://solr:8983/solr/avalon
      - SETTINGS__STREAMING__CONTENT_PATH=/
      - SETTINGS__STREAMING__SERVER=nginx
      - SYSTEM_GROUPS=administrator,group_manager,manager
      - SECRET_KEY_BASE=${SECRET_KEY_BASE}
      - Z3950_ATTRIBUTE
      - Z3950_DATABASE
      - Z3950_HOST
      - Z3950_PORT
    volumes:
      - ./masterfiles:/masterfiles
      - ./gems:/gems
    ports:
      - "80:80"
